# OpenSSL CA scripts (single-tier)

Small, maintainable wrappers around `openssl ca` for a **single-tier** CA:
- Server certificates (TLS)
- Client certificates (mTLS)
- Revoke + CRL
- CA DB helper commands
- Expiration monitoring with optional Telegram notification

## Layout

- `openssl.cnf` — CA configuration (extensions, policy, AIA/CDP, defaults)
- `CA/` — CA certificate and private key
  - `CA/ca.crt` — CA certificate
  - `CA/private/ca.key` — CA private key
- `newcerts/` — OpenSSL CA issued cert store
- `crl/` — CRL output (`crl/crl.pem`)
- `csr/` — CSRs generated by scripts
- `out/` — issued leaf certs/keys/pfx
- `index.txt`, `serial`, `crlnumber`, `index.txt.attr` — OpenSSL CA database files

### Issued certificate files

`openssl ca` writes issued certificates into `newcerts/` using the standard `SERIAL.pem` naming (via `-outdir`).

For convenience, the signing scripts create symlinks in `out/` named:

- `out/<SERIAL>_<CN>.crt` → `newcerts/<SERIAL>.pem`

Symlinks are created idempotently by `ensure_recent_links` (it checks the **5 most recent** certificates in `newcerts/` and creates missing links).

## Configuration

Edit DN defaults in `openssl.cnf` → `[ req_distinguished_name ]`:
- `countryName_default`
- `stateOrProvinceName_default`
- `localityName_default`
- `0.organizationName_default`
- `organizationalUnitName_default`
- `emailAddress_default` (optional)

### AIA / CDP

AIA and CDP are defined **statically** in `openssl.cnf` in `[ aia ]` and `[ crl_dp ]` (near the top).
The OCSP line is intentionally left **commented out**.

## Common tasks

### Create CA (one-time)

```bash
./create_ca.sh
```

What it does:
- Initializes working directories and DB files (idempotent)
- Creates `CA/private/ca.key` and self-signed `CA/ca.crt` (prompts for passphrase)

### Issue a server certificate

```bash
./gen_server.sh app1 -san "DNS.1:app1.example.local,IP.1:10.0.0.10"
```

If `-san` is omitted, a default SAN is used:
- `DNS.1:<APP_NAME>.<dns_suffix>` (configured in `openssl.cnf`)

### Issue a client certificate (mTLS) + PFX

```bash
./gen_client.sh user1
```

Outputs:
- `out/user1.key` — private key
- `out/<SERIAL>_user1.crt` — client certificate
- `out/user1.pfx` — PKCS#12 (cert + key + CA cert)

The PFX export password is prompted once and equals the key encryption password used during key generation.

### Revoke + CRL

Revoke:
```bash
./revoke.sh out/<SERIAL>_app1.crt
```

Generate CRL:
```bash
./gencrl.sh
```

Verify with CRL check (auto-enables CRL if present):
```bash
./verify.sh out/<SERIAL>_app1.crt
```

## Monitoring: expiring certificates

List certs expiring within N days:
```bash
./expire-soon.sh 30
```

Telegram notify:
1) Copy `notify.config.example` → `notify.config` and set values (permissions 0600)
2) Run:
```bash
./expire-soon.sh 30 --notify
```

Config variables:
- `TELEGRAM_BOT_TOKEN`
- `TELEGRAM_CHAT_ID`
- `TELEGRAM_API_URL` (optional, default: https://api.telegram.org)

Override config location:
```bash
NOTIFY_CONFIG=/etc/openssl-ca/notify.config ./expire-soon.sh 30 --notify
```

## Script reference

### Issuance
- `create_server_csr.sh <name> [-san "..."]` — generate server key + CSR
- `create_client_csr.sh <name> [-san "..."]` — generate client key + CSR
- `sign_server_csr.sh <name>` — sign server CSR
- `sign_client_csr.sh <name>` — sign client CSR
- `gen_server.sh <name> [-san "..."]` — create CSR + sign (server)
- `gen_client.sh <name> [-san "..."]` — create CSR + sign (client) + export PFX

### Revocation / CRL
- `revoke.sh <cert.pem>` — revoke a certificate (updates CA DB)
- `gencrl.sh` — generate CRL (`crl/crl.pem`)

### Verification
- `verify.sh <cert.pem>` — verify cert against CA (and CRL if present)

### CA DB helpers
- `status.sh <CN|serial>` — search `index.txt` for CN/serial
- `list-valid.sh` — list valid cert entries from `index.txt`
- `list-revoked.sh` — list revoked cert entries from `index.txt`

### Maintenance
- `clean.sh [--db|--all]` — clean outputs; optional DB reset / full reset
